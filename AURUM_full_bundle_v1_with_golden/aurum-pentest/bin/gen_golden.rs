
use aurum_pentest::{
    aeon::calculate_t_star,
    canon::canonical_tx_bytes,
    hash::blake3_ds,
    merkle::{empty_root, merkle_root},
    vrf_iface::vrf_leader_input,
};
use serde::Serialize;
use std::{fs, path::Path};

#[derive(Serialize)]
struct Golden {
    version: String,
    notes: String,
    empty_root_hex: String,
    sample_tx_bytes_hex: String,
    sample_tx_id_hex: String,
    sample_merkle_root_hex: String,
    sample_vrf_input_hex: String,
    aeon_t_star_sample: f64,
}

fn hex32(x: [u8;32]) -> String { x.iter().map(|b| format!("{:02x}", b)).collect() }
fn hexv(v: &[u8]) -> String { v.iter().map(|b| format!("{:02x}", b)).collect() }

fn main() -> anyhow::Result<()> {
    // ---- 1) Empty root (frozen) ----
    let empty = empty_root().expect("empty root");

    // ---- 2) Canonical Tx ----
    let tx_bytes = canonical_tx_bytes(
        1,               // version
        "NS_FROM_0001",  // from
        "NS_TO_0002",    // to
        123456789u128,   // amount
        1000u128,        // fee
        42u64            // nonce
    )?;
    let tx_id = blake3_ds("AURUM/Tx", &tx_bytes)?;

    // ---- 3) Merkle root of sample leaves ----
    let leaves: Vec<&[u8]> = vec![b"alpha", b"beta", b"gamma"];
    let root = merkle_root(&leaves)?;

    // ---- 4) VRF input sample ----
    let epoch: u64 = 1;
    let slot: u64 = 42;
    let prev_rand: [u8; 32] = [0u8; 32];
    let proposer_pk: Vec<u8> = b"NS_SAMPLE_PROPOSER_PK".to_vec();
    let vrf_in = vrf_leader_input(epoch, slot, prev_rand, &proposer_pk)?;

    // ---- 5) AEON T* sample ----
    let sample_text = b"The quick brown fox jumps over the lazy dog";
    let t_star = calculate_t_star(sample_text);

    let golden = Golden {
        version: "v1".to_string(),
        notes: "Deterministic vectors for CI regression detection. Changing hashing, canonicalization, or VRF input format will alter these.".to_string(),
        empty_root_hex: hex32(empty),
        sample_tx_bytes_hex: hexv(&tx_bytes),
        sample_tx_id_hex: hex32(tx_id),
        sample_merkle_root_hex: hex32(root),
        sample_vrf_input_hex: hex32(vrf_in),
        aeon_t_star_sample: t_star,
    };

    // Write GOLDEN.json at workspace root (../ from aurum-pentest)
    let out_path = Path::new(env!("CARGO_MANIFEST_DIR")).join("..").join("GOLDEN.json");
    let json = serde_json::to_string_pretty(&golden)?;
    fs::write(&out_path, json)?;
    eprintln!("Wrote {}", out_path.display());
    Ok(())
}
